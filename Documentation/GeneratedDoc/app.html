<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>moo-as-voting-fast.app API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>moo-as-voting-fast.app</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import copy
import sys
import main
import ResultsScript.results as results
import numpy as np
import time
import json 
from flask import Flask
from flask import request
import threading
import datetime

from support.binomial_diversity_support import recompute_user_genres_prob, get_user_genre_prob
import support.calibration_support as calibration_support

    
app = Flask(__name__)
app.config[&#39;TEMPLATES_AUTO_RELOAD&#39;] = True
app.config[&#34;DEBUG&#34;] = False
extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles, users_viewed_item,\
      distance_matrix, items,itemIDs, users, userIDs, algorithm_factory, normalizations, args, ease_B, neg_ease_B \
            = None, None, None, None, None, None, None,None,None, None, None, None, None, None, None
lock = threading.Lock()


@app.before_first_request
def init(only_MovieLens = False):
    &#34;&#34;&#34;
    Initialization of the recommender - computation of all needed datasets
    Called before first requets on worker
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
          users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
              normalizations, args, ease_B, neg_ease_B
    start_time =time.perf_counter()
    extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
        users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
            normalizations, args, ease_B, neg_ease_B = main.init(only_MovieLens)
    print(f&#34;Init done, took: {time.perf_counter() - start_time}&#34;)
    if not only_MovieLens:
        x=datetime.datetime.now()
        y = x + datetime.timedelta(days=1)
        y = y.replace(hour=3, minute=30, second=0, microsecond=0)
        threading.Timer((y - x).seconds, init).start()


@app.route(&#39;/Results&#39;, methods=[&#34;POST&#34;, &#34;GET&#34;])
def graphs():
    results.process()

@app.route(&#39;/getRecommendations/&lt;user_id&gt;&#39;, methods=[&#34;POST&#34;, &#34;GET&#34;])
def index(user_id):
    &#34;&#34;&#34;
    Process request on recommendations from user

    Parameters
    ----------
    user_id : str
        ID of user that send the request

    Returns
    -------
    dict
        list of recommended items and their supports for each metric
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
          users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
            normalizations, args, ease_B, neg_ease_B
    result=[]
    if(request.is_json):
        json_data = request.get_json()
        metrics, whitelistindices, blacklistindices, currentlistindices, metric_variants = get_arguments(json_data)
        client_args = set_client_args(args, json_data, metric_variants)
        user_id = int(user_id)  
        if (user_id not in userIDs):
            create_new_user(user_id)
        userindex = userIDs.index(user_id)      
        rated, scores, pos_rated = get_rated(client_args, user_id, userindex)
        set_rating_matrices_row(rated, scores, client_args, userindex)
        recompute_user_genres_prob(userindex, pos_rated) 
        calibration_support.set_user_genre_prob(userindex, get_user_genre_prob()[userindex])
        user_mask = get_mask(whitelistindices, blacklistindices, currentlistindices)
        result, support = main.predict_for_user(users[userindex], userindex, items, extended_rating_matrix,\
                                            neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
                                                    distance_matrix,\
                                            users_viewed_item, normalizations, np.array(user_mask),\
                                            algorithm_factory,client_args, metrics, len(users),\
                                            currentlistindices)
        result = np.squeeze(result)
        for i in range(len(support)):
            for j in range(len(support[0])):
                support[i][j] = max(np.nan_to_num(support[i][j]),0) 
        result = {itemIDs[int(result[i])]: support[i] for i in range(len(result))}
    return json.dumps(result)


def set_client_args(args, json_data, metric_variants):
    &#34;&#34;&#34;

    Parameters
    ----------
    client_args : SimpleNamespace
        All arguments of RS
    json_data : dict
        Data in json sent as part of request
    metric_variants : list
        list of codes of selected metrics variants

    Returns
    -------
    SimpleNamespace
        All arguments of RS for this request
    &#34;&#34;&#34;
    client_args=copy.deepcopy(args)
    client_args.k = json_data[&#34;count&#34;]
    client_args.discount_sequences = np.stack([np.geomspace(start=1.0,stop=d**(client_args.k *10),
                                                            num=client_args.k * 10, endpoint=False) 
                                                            for d in client_args.discounts], axis=0)
    if(len(metric_variants)&gt;3):
            if (metric_variants[0] is not None) and (metric_variants[0]!=&#34;&#34;):
                client_args.relevance = metric_variants[0]
            if (metric_variants[1] is not None) and (metric_variants[1]!=&#34;&#34;):
                client_args.diversity = metric_variants[1]
            if (metric_variants[2] is not None) and (metric_variants[2]!=&#34;&#34;):
                client_args.novelty = metric_variants[2]
            if (metric_variants[3] is not None) and (metric_variants[3]!=&#34;&#34;):
                client_args.popularity = metric_variants[3]
    return client_args


def get_arguments(json_data): 
    &#34;&#34;&#34;

    Parameters
    ----------
    json_data : dict
        Data in json sent as part of request

    Returns
    -------
    list
        list of parameters for getting recommendations retrieved from the body of the request
    &#34;&#34;&#34;
    whiteListItemIDs = json_data[&#34;whiteListItemIDs&#34;]
    blackListItemIDs = json_data[&#34;blackListItemIDs&#34;]
    curentListItemIDs = json_data[&#34;currentListItemIDs&#34;]  
    metrics  = np.array([importance / sum(json_data[&#34;metrics&#34;]) for importance in json_data[&#34;metrics&#34;]])        
    whitelistindices = [itemIDs.index(int(item_id)) for item_id in whiteListItemIDs if int(item_id) in itemIDs]
    blacklistindices = [itemIDs.index(int(item_id)) for item_id in blackListItemIDs if int(item_id) in itemIDs]
    currentlistindices = [itemIDs.index(int(item_id)) for item_id in curentListItemIDs if int(item_id) in itemIDs]
    metric_variants = json_data[&#34;metricVariantsCodes&#34;]
    return metrics, whitelistindices, blacklistindices, currentlistindices, metric_variants


def get_rated(client_args, user_id, userindex):
    &#34;&#34;&#34;

    Parameters
    ----------
    client_args : : SimpleNamespace
        All arguments of RS
    user_id : int
        ID of user that send the request
    userindex : int
        index of the user in datasets

    Returns
    -------
    list
        list of items rated by user, list of rating values, list of items positively rated by user
    &#34;&#34;&#34;
    global pos_users_profiles, neg_users_profiles
    neg_rated = main.get_ratings_of_user(args.connectionstring, user_id,\
                                        only_positive=False)
    pos_rated = neg_rated[neg_rated[&#34;ratingscore&#34;] &gt; 5]
    pos_scores = list(pos_rated[&#34;ratingscore&#34;].apply(lambda x: x/10.0 if x&gt;5 else 0))
    neg_scores = list(neg_rated[&#34;ratingscore&#34;].apply(lambda x: (x - 5) * 2 /10.0))
    pos_rated = list(pos_rated[&#34;itemid&#34;])
    pos_rated = list(map(itemIDs.index, pos_rated))
    neg_rated = list(neg_rated[&#34;itemid&#34;])
    neg_rated = list(map(itemIDs.index, neg_rated))
    rated = pos_rated
    scores = pos_scores
    if (client_args.relevance == &#34;also_negative&#34;):
        rated = neg_rated
        scores = neg_scores
    pos_users_profiles[userindex] = pos_rated
    neg_users_profiles[userindex] = neg_rated
    return rated, scores, pos_rated


def create_new_user(user_id):
    &#34;&#34;&#34;
    Creates new user and add him to every dataset

    Parameters
    ----------
    user_id : int
        ID of user that send the request
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, userIDs, users, pos_users_profiles, neg_users_profiles
    lock.acquire()
    try:
        extended_rating_matrix = np.append(extended_rating_matrix, [np.zeros(len(items),dtype=np.float32)], axis=0)
        neg_extended_rating_matrix = np.append(neg_extended_rating_matrix, [np.zeros(len(items),dtype=np.float32)], axis=0)
        userIDs.append(user_id)
        users = np.append(users,[len(users)])
        get_user_genre_prob().append(np.array([0]* len(get_user_genre_prob()[0]))) 
        calibration_support.get_user_genre_prob().append(np.array([0]* len(get_user_genre_prob()[0]))) 
        pos_users_profiles = np.append(pos_users_profiles,[-1])
        neg_users_profiles = np.append(neg_users_profiles,[-1])
    except:
        debug =1
    finally:
        lock.release()


def set_rating_matrices_row(rated, scores, client_args, userindex):
    &#34;&#34;&#34;
    Sets new predtiction values in matrix row corresponding to user

    Parameters
    ----------
    rated : list
        list of items rated by user
    scores : list
        list of rating values
    client_args : SimpleNamespace
        All arguments of RS
    userindex : int
        index of the user in datasets
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix
    user_X = np.zeros(len(items),dtype=np.float64)
    user_X[rated] = scores   
    if(client_args.relevance == &#34;also_negative&#34;):
        neg_extended_rating_matrix[userindex] = user_X.dot(neg_ease_B)
    else:
        extended_rating_matrix[userindex] = user_X.dot(ease_B)


def get_mask(whitelistindices, blacklistindices, currentlistindices):
    &#34;&#34;&#34;

    Parameters
    ----------
    whitelistindices : list
        list of items that can be recommended to user
    blacklistindices : list
        list of items that can&#39;t be recommended to user
    currentlistindices : list
        list of items that are already part of the list of the recommendations

    Returns
    -------
    np.ndarray
        array that contains 1 in the indices of items that can be recommended, 0 otherwise
    &#34;&#34;&#34;
    user_mask = [np.ones(len(items),dtype=np.bool8)]
    if(len(whitelistindices)&gt;0):
        user_mask = [np.zeros(len( user_mask[0]),dtype=np.bool8)]
        for i in whitelistindices:
            user_mask[0][i]=True
    for i in blacklistindices:
        user_mask[0][i]=False
    for i in currentlistindices:
        user_mask[0][i]=False
    return user_mask


@app.route(&#39;/start&#39;)
def start():
    return &#34;&#34;


if __name__ == &#34;__main__&#34;:
    app.run(threaded=True)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="moo-as-voting-fast.app.create_new_user"><code class="name flex">
<span>def <span class="ident">create_new_user</span></span>(<span>user_id)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates new user and add him to every dataset</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>user_id</code></strong> :&ensp;<code>int</code></dt>
<dd>ID of user that send the request</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_new_user(user_id):
    &#34;&#34;&#34;
    Creates new user and add him to every dataset

    Parameters
    ----------
    user_id : int
        ID of user that send the request
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, userIDs, users, pos_users_profiles, neg_users_profiles
    lock.acquire()
    try:
        extended_rating_matrix = np.append(extended_rating_matrix, [np.zeros(len(items),dtype=np.float32)], axis=0)
        neg_extended_rating_matrix = np.append(neg_extended_rating_matrix, [np.zeros(len(items),dtype=np.float32)], axis=0)
        userIDs.append(user_id)
        users = np.append(users,[len(users)])
        get_user_genre_prob().append(np.array([0]* len(get_user_genre_prob()[0]))) 
        calibration_support.get_user_genre_prob().append(np.array([0]* len(get_user_genre_prob()[0]))) 
        pos_users_profiles = np.append(pos_users_profiles,[-1])
        neg_users_profiles = np.append(neg_users_profiles,[-1])
    except:
        debug =1
    finally:
        lock.release()</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.get_arguments"><code class="name flex">
<span>def <span class="ident">get_arguments</span></span>(<span>json_data)</span>
</code></dt>
<dd>
<div class="desc"><h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>json_data</code></strong> :&ensp;<code>dict</code></dt>
<dd>Data in json sent as part of request</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code></dt>
<dd>list of parameters for getting recommendations retrieved from the body of the request</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_arguments(json_data): 
    &#34;&#34;&#34;

    Parameters
    ----------
    json_data : dict
        Data in json sent as part of request

    Returns
    -------
    list
        list of parameters for getting recommendations retrieved from the body of the request
    &#34;&#34;&#34;
    whiteListItemIDs = json_data[&#34;whiteListItemIDs&#34;]
    blackListItemIDs = json_data[&#34;blackListItemIDs&#34;]
    curentListItemIDs = json_data[&#34;currentListItemIDs&#34;]  
    metrics  = np.array([importance / sum(json_data[&#34;metrics&#34;]) for importance in json_data[&#34;metrics&#34;]])        
    whitelistindices = [itemIDs.index(int(item_id)) for item_id in whiteListItemIDs if int(item_id) in itemIDs]
    blacklistindices = [itemIDs.index(int(item_id)) for item_id in blackListItemIDs if int(item_id) in itemIDs]
    currentlistindices = [itemIDs.index(int(item_id)) for item_id in curentListItemIDs if int(item_id) in itemIDs]
    metric_variants = json_data[&#34;metricVariantsCodes&#34;]
    return metrics, whitelistindices, blacklistindices, currentlistindices, metric_variants</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.get_mask"><code class="name flex">
<span>def <span class="ident">get_mask</span></span>(<span>whitelistindices, blacklistindices, currentlistindices)</span>
</code></dt>
<dd>
<div class="desc"><h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>whitelistindices</code></strong> :&ensp;<code>list</code></dt>
<dd>list of items that can be recommended to user</dd>
<dt><strong><code>blacklistindices</code></strong> :&ensp;<code>list</code></dt>
<dd>list of items that can't be recommended to user</dd>
<dt><strong><code>currentlistindices</code></strong> :&ensp;<code>list</code></dt>
<dd>list of items that are already part of the list of the recommendations</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>np.ndarray</code></dt>
<dd>array that contains 1 in the indices of items that can be recommended, 0 otherwise</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_mask(whitelistindices, blacklistindices, currentlistindices):
    &#34;&#34;&#34;

    Parameters
    ----------
    whitelistindices : list
        list of items that can be recommended to user
    blacklistindices : list
        list of items that can&#39;t be recommended to user
    currentlistindices : list
        list of items that are already part of the list of the recommendations

    Returns
    -------
    np.ndarray
        array that contains 1 in the indices of items that can be recommended, 0 otherwise
    &#34;&#34;&#34;
    user_mask = [np.ones(len(items),dtype=np.bool8)]
    if(len(whitelistindices)&gt;0):
        user_mask = [np.zeros(len( user_mask[0]),dtype=np.bool8)]
        for i in whitelistindices:
            user_mask[0][i]=True
    for i in blacklistindices:
        user_mask[0][i]=False
    for i in currentlistindices:
        user_mask[0][i]=False
    return user_mask</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.get_rated"><code class="name flex">
<span>def <span class="ident">get_rated</span></span>(<span>client_args, user_id, userindex)</span>
</code></dt>
<dd>
<div class="desc"><h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>client_args</code></strong> :&ensp;<code>: SimpleNamespace</code></dt>
<dd>All arguments of RS</dd>
<dt><strong><code>user_id</code></strong> :&ensp;<code>int</code></dt>
<dd>ID of user that send the request</dd>
<dt><strong><code>userindex</code></strong> :&ensp;<code>int</code></dt>
<dd>index of the user in datasets</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code></dt>
<dd>list of items rated by user, list of rating values, list of items positively rated by user</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_rated(client_args, user_id, userindex):
    &#34;&#34;&#34;

    Parameters
    ----------
    client_args : : SimpleNamespace
        All arguments of RS
    user_id : int
        ID of user that send the request
    userindex : int
        index of the user in datasets

    Returns
    -------
    list
        list of items rated by user, list of rating values, list of items positively rated by user
    &#34;&#34;&#34;
    global pos_users_profiles, neg_users_profiles
    neg_rated = main.get_ratings_of_user(args.connectionstring, user_id,\
                                        only_positive=False)
    pos_rated = neg_rated[neg_rated[&#34;ratingscore&#34;] &gt; 5]
    pos_scores = list(pos_rated[&#34;ratingscore&#34;].apply(lambda x: x/10.0 if x&gt;5 else 0))
    neg_scores = list(neg_rated[&#34;ratingscore&#34;].apply(lambda x: (x - 5) * 2 /10.0))
    pos_rated = list(pos_rated[&#34;itemid&#34;])
    pos_rated = list(map(itemIDs.index, pos_rated))
    neg_rated = list(neg_rated[&#34;itemid&#34;])
    neg_rated = list(map(itemIDs.index, neg_rated))
    rated = pos_rated
    scores = pos_scores
    if (client_args.relevance == &#34;also_negative&#34;):
        rated = neg_rated
        scores = neg_scores
    pos_users_profiles[userindex] = pos_rated
    neg_users_profiles[userindex] = neg_rated
    return rated, scores, pos_rated</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.graphs"><code class="name flex">
<span>def <span class="ident">graphs</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/Results&#39;, methods=[&#34;POST&#34;, &#34;GET&#34;])
def graphs():
    results.process()</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.index"><code class="name flex">
<span>def <span class="ident">index</span></span>(<span>user_id)</span>
</code></dt>
<dd>
<div class="desc"><p>Process request on recommendations from user</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>user_id</code></strong> :&ensp;<code>str</code></dt>
<dd>ID of user that send the request</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>list of recommended items and their supports for each metric</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/getRecommendations/&lt;user_id&gt;&#39;, methods=[&#34;POST&#34;, &#34;GET&#34;])
def index(user_id):
    &#34;&#34;&#34;
    Process request on recommendations from user

    Parameters
    ----------
    user_id : str
        ID of user that send the request

    Returns
    -------
    dict
        list of recommended items and their supports for each metric
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
          users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
            normalizations, args, ease_B, neg_ease_B
    result=[]
    if(request.is_json):
        json_data = request.get_json()
        metrics, whitelistindices, blacklistindices, currentlistindices, metric_variants = get_arguments(json_data)
        client_args = set_client_args(args, json_data, metric_variants)
        user_id = int(user_id)  
        if (user_id not in userIDs):
            create_new_user(user_id)
        userindex = userIDs.index(user_id)      
        rated, scores, pos_rated = get_rated(client_args, user_id, userindex)
        set_rating_matrices_row(rated, scores, client_args, userindex)
        recompute_user_genres_prob(userindex, pos_rated) 
        calibration_support.set_user_genre_prob(userindex, get_user_genre_prob()[userindex])
        user_mask = get_mask(whitelistindices, blacklistindices, currentlistindices)
        result, support = main.predict_for_user(users[userindex], userindex, items, extended_rating_matrix,\
                                            neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
                                                    distance_matrix,\
                                            users_viewed_item, normalizations, np.array(user_mask),\
                                            algorithm_factory,client_args, metrics, len(users),\
                                            currentlistindices)
        result = np.squeeze(result)
        for i in range(len(support)):
            for j in range(len(support[0])):
                support[i][j] = max(np.nan_to_num(support[i][j]),0) 
        result = {itemIDs[int(result[i])]: support[i] for i in range(len(result))}
    return json.dumps(result)</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.init"><code class="name flex">
<span>def <span class="ident">init</span></span>(<span>only_MovieLens=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Initialization of the recommender - computation of all needed datasets
Called before first requets on worker</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.before_first_request
def init(only_MovieLens = False):
    &#34;&#34;&#34;
    Initialization of the recommender - computation of all needed datasets
    Called before first requets on worker
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
          users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
              normalizations, args, ease_B, neg_ease_B
    start_time =time.perf_counter()
    extended_rating_matrix, neg_extended_rating_matrix, pos_users_profiles, neg_users_profiles,\
        users_viewed_item, distance_matrix, items,itemIDs, users, userIDs, algorithm_factory,\
            normalizations, args, ease_B, neg_ease_B = main.init(only_MovieLens)
    print(f&#34;Init done, took: {time.perf_counter() - start_time}&#34;)
    if not only_MovieLens:
        x=datetime.datetime.now()
        y = x + datetime.timedelta(days=1)
        y = y.replace(hour=3, minute=30, second=0, microsecond=0)
        threading.Timer((y - x).seconds, init).start()</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.set_client_args"><code class="name flex">
<span>def <span class="ident">set_client_args</span></span>(<span>args, json_data, metric_variants)</span>
</code></dt>
<dd>
<div class="desc"><h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>client_args</code></strong> :&ensp;<code>SimpleNamespace</code></dt>
<dd>All arguments of RS</dd>
<dt><strong><code>json_data</code></strong> :&ensp;<code>dict</code></dt>
<dd>Data in json sent as part of request</dd>
<dt><strong><code>metric_variants</code></strong> :&ensp;<code>list</code></dt>
<dd>list of codes of selected metrics variants</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>SimpleNamespace</code></dt>
<dd>All arguments of RS for this request</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_client_args(args, json_data, metric_variants):
    &#34;&#34;&#34;

    Parameters
    ----------
    client_args : SimpleNamespace
        All arguments of RS
    json_data : dict
        Data in json sent as part of request
    metric_variants : list
        list of codes of selected metrics variants

    Returns
    -------
    SimpleNamespace
        All arguments of RS for this request
    &#34;&#34;&#34;
    client_args=copy.deepcopy(args)
    client_args.k = json_data[&#34;count&#34;]
    client_args.discount_sequences = np.stack([np.geomspace(start=1.0,stop=d**(client_args.k *10),
                                                            num=client_args.k * 10, endpoint=False) 
                                                            for d in client_args.discounts], axis=0)
    if(len(metric_variants)&gt;3):
            if (metric_variants[0] is not None) and (metric_variants[0]!=&#34;&#34;):
                client_args.relevance = metric_variants[0]
            if (metric_variants[1] is not None) and (metric_variants[1]!=&#34;&#34;):
                client_args.diversity = metric_variants[1]
            if (metric_variants[2] is not None) and (metric_variants[2]!=&#34;&#34;):
                client_args.novelty = metric_variants[2]
            if (metric_variants[3] is not None) and (metric_variants[3]!=&#34;&#34;):
                client_args.popularity = metric_variants[3]
    return client_args</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.set_rating_matrices_row"><code class="name flex">
<span>def <span class="ident">set_rating_matrices_row</span></span>(<span>rated, scores, client_args, userindex)</span>
</code></dt>
<dd>
<div class="desc"><p>Sets new predtiction values in matrix row corresponding to user</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>rated</code></strong> :&ensp;<code>list</code></dt>
<dd>list of items rated by user</dd>
<dt><strong><code>scores</code></strong> :&ensp;<code>list</code></dt>
<dd>list of rating values</dd>
<dt><strong><code>client_args</code></strong> :&ensp;<code>SimpleNamespace</code></dt>
<dd>All arguments of RS</dd>
<dt><strong><code>userindex</code></strong> :&ensp;<code>int</code></dt>
<dd>index of the user in datasets</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_rating_matrices_row(rated, scores, client_args, userindex):
    &#34;&#34;&#34;
    Sets new predtiction values in matrix row corresponding to user

    Parameters
    ----------
    rated : list
        list of items rated by user
    scores : list
        list of rating values
    client_args : SimpleNamespace
        All arguments of RS
    userindex : int
        index of the user in datasets
    &#34;&#34;&#34;
    global extended_rating_matrix, neg_extended_rating_matrix
    user_X = np.zeros(len(items),dtype=np.float64)
    user_X[rated] = scores   
    if(client_args.relevance == &#34;also_negative&#34;):
        neg_extended_rating_matrix[userindex] = user_X.dot(neg_ease_B)
    else:
        extended_rating_matrix[userindex] = user_X.dot(ease_B)</code></pre>
</details>
</dd>
<dt id="moo-as-voting-fast.app.start"><code class="name flex">
<span>def <span class="ident">start</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/start&#39;)
def start():
    return &#34;&#34;</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="moo-as-voting-fast" href="index.html">moo-as-voting-fast</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="moo-as-voting-fast.app.create_new_user" href="#moo-as-voting-fast.app.create_new_user">create_new_user</a></code></li>
<li><code><a title="moo-as-voting-fast.app.get_arguments" href="#moo-as-voting-fast.app.get_arguments">get_arguments</a></code></li>
<li><code><a title="moo-as-voting-fast.app.get_mask" href="#moo-as-voting-fast.app.get_mask">get_mask</a></code></li>
<li><code><a title="moo-as-voting-fast.app.get_rated" href="#moo-as-voting-fast.app.get_rated">get_rated</a></code></li>
<li><code><a title="moo-as-voting-fast.app.graphs" href="#moo-as-voting-fast.app.graphs">graphs</a></code></li>
<li><code><a title="moo-as-voting-fast.app.index" href="#moo-as-voting-fast.app.index">index</a></code></li>
<li><code><a title="moo-as-voting-fast.app.init" href="#moo-as-voting-fast.app.init">init</a></code></li>
<li><code><a title="moo-as-voting-fast.app.set_client_args" href="#moo-as-voting-fast.app.set_client_args">set_client_args</a></code></li>
<li><code><a title="moo-as-voting-fast.app.set_rating_matrices_row" href="#moo-as-voting-fast.app.set_rating_matrices_row">set_rating_matrices_row</a></code></li>
<li><code><a title="moo-as-voting-fast.app.start" href="#moo-as-voting-fast.app.start">start</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>